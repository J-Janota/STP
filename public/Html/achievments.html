<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="../Styles/css/reset.css">
    <link rel="stylesheet" href="../Styles/css/styles.css">
    <link rel="stylesheet" href="../Styles/css/achievements.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>

<body>
    <nav class="mainNav">
        <!-- Navigation content -->
        <ul class="navbar-list">
            <li class="navbar-list-item">
                <a href="dashboard.html" class="navbar-link unselectable">
                    <span class="material-symbols-outlined">
                        arrow_back
                    </span>
                    <p class="label">Back to Dashboard</p>
                </a>
            </li>
        </ul>
    </nav>
    <main>
        <h1>Achievements</h1>
        <section class="summaryCards">
            <div class="summaryCard">
                <span class="summaryCardInfo">
                    <h2>Total Unlocked</h2>
                    <span class="material-symbols-outlined">
                        trophy
                    </span>
                </span>
                <span class="summaryCardValue">0/9</span>
                <div class="progressBarContainer">
                    <span class="progressBar"></span>
                </div>
            </div>
                <div class="summaryCard">
                    <span class="summaryCardInfo">
                        <h2>Current Streak</h2>
                        <span class="material-symbols-outlined">
                            local_fire_department
                        </span>
                    </span>
                    <span class="summaryCardValue">0 days</span>
                    <span class="additionalText">Longest: 0 Days</span>
                </div>
                <div class="summaryCard">
                    <span class="summaryCardInfo">
                        <h2>Cards Studied</h2>
                        <span class="material-symbols-outlined">
                            import_contacts
                        </span>
                    </span>
                    <span class="summaryCardValue">0</span>
                    <span class="additionalText">0 sessions</span>
                </div>
        </section>
        <ul class="achievementFilter">
            <li class="achievementFilterItem unselectable">
                <button class=" filterButton active">All</button>
            </li>
            <li class="achievementFilterItem unselectable">
                <button class="filterButton">Study</button>
            </li>
            <li class="achievementFilterItem unselectable">
                <button class="filterButton">Streak</button>
            </li>
            <li class="achievementFilterItem unselectable">
                <button class="filterButton">Social</button>
            </li>
            <li class="achievementFilterItem unselectable">
                <button class="filterButton">Mastery</button>
            </li>
        </ul>
        <section class="achievementCards">
            <!-- Achievement cards will be dynamically inserted here -->
        </section>
    </main>
    <script src="../Scripts/index.js"></script>
    <script>
        const achievementCardTemplate = `
                <span class="material-symbols-outlined achievementIcon">
                    import_contacts
                </span>
                <span class="achievementCardInfo">
                    <h2>First Steps</h2>
                    <p>Study your first flashcard</p>
                </span>
                <div class="progressBarContainer">
                    <span class="progressBar"></span>
                </div>
                <span class="percentageProgress">0% complete</span>
        `;

        let allCards = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch all data in parallel
                const [userDataRes, userAchRes, allAchRes] = await Promise.all([
                    fetch('/userdata', {
                        credentials: 'include',
                        headers: { 'Accept': 'application/json' },
                        cache: 'no-store'
                    }),
                    fetch('/userachievements', {
                        credentials: 'include',
                        headers: { 'Accept': 'application/json' },
                        cache: 'no-store'
                    }),
                    fetch('/achievements', {
                        credentials: 'include',
                        headers: { 'Accept': 'application/json' },
                        cache: 'no-store'
                    })
                ]);

                if (!userDataRes.ok || !userAchRes.ok || !allAchRes.ok) {
                    console.warn('Failed to load data');
                    return;
                }

                const userData = await userDataRes.json();
                const userAchData = await userAchRes.json();
                const allAchData = await allAchRes.json();

                const userAchievements = userAchData.userAchievements || [];
                const allAchievements = allAchData.achievements || [];

                console.log('User Data:', userData);
                console.log('User Achievements:', userAchievements);
                console.log('All Achievements:', allAchievements);

                // Create a map of achievement_id -> user progress
                const progressMap = new Map();
                userAchievements.forEach(ua => {
                    progressMap.set(ua.id, {
                        progress: ua.progress || 0,
                        earned_at: ua.earned_at
                    });
                });

                // Update summary cards
                const unlockedCount = userAchievements.filter(ua => (ua.progress || 0) >= (ua.goal || ua.target || 1)).length;
                const totalCount = allAchievements.length;
                const progressPercent = totalCount > 0 ? (unlockedCount / totalCount) * 100 : 0;

                document.querySelector('.summaryCards .summaryCard:nth-child(1) .summaryCardValue').textContent = `${unlockedCount}/${totalCount}`;
                document.querySelector('.summaryCards .summaryCard:nth-child(1) .progressBar').style.width = `${progressPercent}%`;

                document.querySelector('.summaryCards .summaryCard:nth-child(2) .summaryCardValue').textContent = `${userData.studyStreak || 0} days`;
                document.querySelector('.summaryCards .summaryCard:nth-child(2) .additionalText').textContent = `Longest: ${userData.longestStreak || 0} Days`;

                document.querySelector('.summaryCards .summaryCard:nth-child(3) .summaryCardValue').textContent = userData.flashcardsStudied || 0;
                // sessions placeholder - update if you have session data
                document.querySelector('.summaryCards .summaryCard:nth-child(3) .additionalText').textContent = `0 sessions`;

                // Separate unlocked and locked achievements
                const unlockedAchievements = [];
                const lockedAchievements = [];

                allAchievements.forEach(achievement => {
                    const userProgress = progressMap.get(achievement.id);
                    const currentProgress = userProgress ? userProgress.progress : 0;
                    const targetProgress = achievement.goal || achievement.target || 1;
                    const isUnlocked = currentProgress >= targetProgress;

                    if (isUnlocked) {
                        unlockedAchievements.push(achievement);
                    } else {
                        lockedAchievements.push(achievement);
                    }
                });

                // Render achievements
                const achievementCardsContainer = document.querySelector('.achievementCards');
                achievementCardsContainer.innerHTML = '';

                // Render unlocked first
                unlockedAchievements.forEach(achievement => {
                    const achEl = document.createElement('div');
                    achEl.classList.add('achievementCard', 'unlocked');

                    // Add category class
                    const categoryMap = {
                        study: 'studyCard',
                        streak: 'streakCard',
                        social: 'socialCard',
                        mastery: 'masteryCard'
                    };
                    const categoryClass = categoryMap[(achievement.category || '').toLowerCase()];
                    if (categoryClass) achEl.classList.add(categoryClass);

                    achEl.innerHTML = achievementCardTemplate;
                    achEl.querySelector('.achievementIcon').textContent = achievement.icon;
                    achEl.querySelector('.achievementCardInfo h2').textContent = achievement.name || achievement.title;
                    achEl.querySelector('.achievementCardInfo p').textContent = achievement.description;

                    const progressBar = achEl.querySelector('.progressBar');
                    const percentageProgress = achEl.querySelector('.percentageProgress');
                    progressBar.style.width = '100%';
                    percentageProgress.textContent = '100% complete';

                    achievementCardsContainer.appendChild(achEl);
                });

                // Then render locked
                lockedAchievements.forEach(achievement => {
                    const achEl = document.createElement('div');
                    achEl.classList.add('achievementCard', 'locked');

                    // Add category class
                    const categoryMap = {
                        study: 'studyCard',
                        streak: 'streakCard',
                        social: 'socialCard',
                        mastery: 'masteryCard'
                    };
                    const categoryClass = categoryMap[(achievement.category || '').toLowerCase()];
                    if (categoryClass) achEl.classList.add(categoryClass);

                    achEl.innerHTML = achievementCardTemplate;
                    achEl.querySelector('.achievementIcon').textContent = 'lock';
                    achEl.querySelector('.achievementCardInfo h2').textContent = achievement.name || achievement.title;
                    achEl.querySelector('.achievementCardInfo p').textContent = achievement.description;

                    const progressBar = achEl.querySelector('.progressBar');
                    const percentageProgress = achEl.querySelector('.percentageProgress');

                    // Get user's current progress for this achievement
                    const userProgress = progressMap.get(achievement.id);
                    const currentProgress = userProgress ? userProgress.progress : 0;
                    const targetProgress = achievement.goal || 1;
                    const progressPercent = Math.min((currentProgress / targetProgress) * 100, 100);

                    progressBar.style.width = `${progressPercent}%`;
                    percentageProgress.textContent = `${Math.floor(progressPercent)}% complete`;

                    achievementCardsContainer.appendChild(achEl);
                });

                // Update allCards for filtering
                allCards = document.querySelectorAll('.achievementCard');

                console.log('Achievements loaded successfully');
            } catch (error) {
                console.error('Error fetching achievements:', error);
            }
        });

        function filterCards(category) {
            allCards.forEach(card => card.classList.add('hidden'));

            if (category === 'all') {
                allCards.forEach(card => card.classList.remove('hidden'));
                return;
            }

            const categoryMap = {
                study: 'studyCard',
                streak: 'streakCard',
                social: 'socialCard',
                mastery: 'masteryCard'
            };

            const cardClass = categoryMap[category];
            if (!cardClass) return;

            allCards.forEach(card => {
                if (card.classList.contains(cardClass)) {
                    card.classList.remove('hidden');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.achievementFilter');

            container.addEventListener('click', (e) => {
                const btn = e.target.closest('.filterButton');
                if (!btn) return;

                container.querySelectorAll('.filterButton').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const category = btn.textContent.trim().toLowerCase();
                filterCards(category);
            });
        });


    </script>
</body>

</html>